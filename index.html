<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>キャッシャー集計 ver0.5.4</title>
  <style>
    body {
      font-family: monospace;
      margin: 20px;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid #ccc;
    }
    #inputs {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 5px;
    }
    label {
      width: 200px;
      display: inline-block;
    }
    input[type="number"] {
      width: 80px;
      text-align: center;
    }
    #output {
      margin-top: 20px;
      white-space: pre;
      font-family: monospace;
    }
    #copyButton {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
    }
    #totalPrice {
      font-size: 22px;
      font-weight: bold;
      color: red;
      margin-top: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>キャッシャー集計 ver0.5.4</h1>
  <span>更新日: 2025/04/27</span>
</div>

<input type="file" id="csvFileInput" accept=".csv" />

<div id="inputs">
  <h2>カテゴリごとの料金設定</h2>
  <div class="input-group"><label>22-1 男性 料金:</label><input type="number" id="price_22m" value="0"></div>
  <div class="input-group"><label>22-1 女性 料金:</label><input type="number" id="price_22w" value="0"></div>
  <div class="input-group"><label>ローカル男性 料金:</label><input type="number" id="price_localm" value="0"></div>
  <div class="input-group"><label>ローカル女性 料金:</label><input type="number" id="price_localw" value="0"></div>
  <div class="input-group"><label>ローカルG男性 料金:</label><input type="number" id="price_localgm" value="0"></div>
  <div class="input-group"><label>ローカルG女性 料金:</label><input type="number" id="price_localgw" value="0"></div>
  <div class="input-group"><label>G男性 料金:</label><input type="number" id="price_gm" value="0"></div>
  <div class="input-group"><label>G女性 料金:</label><input type="number" id="price_gw" value="0"></div>
  <div class="input-group"><label>ゲスト男性 料金:</label><input type="number" id="price_guestm" value="0"></div>
  <div class="input-group"><label>ゲスト女性 料金:</label><input type="number" id="price_guestw" value="0"></div>
  <div class="input-group"><label>22:00-1:00ゲスト男性 料金:</label><input type="number" id="price_22guestm" value="0"></div>
  <div class="input-group"><label>22:00-1:00ゲスト女性 料金:</label><input type="number" id="price_22guestw" value="0"></div>
</div>

<div id="categorySummary"></div>
<div id="totalPrice"></div>
<div id="output"></div>

<button id="copyButton" onclick="copyText()">コピー</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
let shopData = {};
let summaryData = {};
let categoryCount = {};

const categoryKeys = [
  '22m', '22w', 'localm', 'localw', 'localgm', 'localgw',
  'gm', 'gw', 'guestm', 'guestw', '22guestm', '22guestw'
];

const categoryLabels = {
  '22m': '22-1 男性',
  '22w': '22-1 女性',
  'localm': 'ローカル男性',
  'localw': 'ローカル女性',
  'localgm': 'ローカルG男性',
  'localgw': 'ローカルG女性',
  'gm': 'G男性',
  'gw': 'G女性',
  'guestm': 'ゲスト男性',
  'guestw': 'ゲスト女性',
  '22guestm': '22:00-1:00ゲスト男性',
  '22guestw': '22:00-1:00ゲスト女性'
};

document.getElementById('csvFileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const text = new TextDecoder('shift-jis').decode(e.target.result);
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        processCSVData(data);
        updateDisplay();
      }
    });
  };
  reader.readAsArrayBuffer(file);
});

function getYesterdayDate() {
  const today = new Date();
  today.setDate(today.getDate() - 1);
  return `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
}

function padRight(str, length) {
  return (str + ' '.repeat(length)).slice(0, length);
}

function padLeft(str, length) {
  str = String(str);
  return ' '.repeat(length - str.length) + str;
}

function processCSVData(data) {
  categoryCount = {};
  categoryKeys.forEach(key => categoryCount[key] = 0);

  let door = 0, foreignDoor = 0, doorLate = 0, foreignDoorLate = 0;
  let total = 0, maleTotal = 0, femaleTotal = 0, foreignTotal = 0;
  shopData = {};

  let countColumn = Object.keys(data[0]).find(key => key.replace(/\s/g, '').includes('販売商品数'));
  if (!countColumn) {
    document.getElementById('output').innerText = 'データが空です';
    return;
  }

  data.forEach(row => {
    const item = row['商品名']?.trim();
    if (!item || item.includes('再入場')) return;

    const count = parseFloat(row[countColumn]) || 0;
    const itemFixed = item.replace(/22~1/g, '22-1');
    const normalizedItem = itemFixed.replace(/^22-1\s*/, '');

    total += count;

    if (itemFixed.includes('22-1ゲスト男性')) categoryCount['22guestm'] += count;
    else if (itemFixed.includes('22-1ゲスト女性')) categoryCount['22guestw'] += count;
    else if (itemFixed.includes('22-1男性')) categoryCount['22m'] += count;
    else if (itemFixed.includes('22-1女性')) categoryCount['22w'] += count;
    else if (itemFixed.includes('ローカルG男性')) categoryCount['localgm'] += count;
    else if (itemFixed.includes('ローカルG女性')) categoryCount['localgw'] += count;
    else if (itemFixed.includes('ローカル男性')) categoryCount['localm'] += count;
    else if (itemFixed.includes('ローカル女性')) categoryCount['localw'] += count;
    else if (itemFixed.includes('G男性')) categoryCount['gm'] += count;
    else if (itemFixed.includes('G女性')) categoryCount['gw'] += count;
    else if (itemFixed.includes('ゲスト男性')) categoryCount['guestm'] += count;
    else if (itemFixed.includes('ゲスト女性')) categoryCount['guestw'] += count;

    const shopMatch = normalizedItem.match(/^(.+?)(ゲスト|フリー)(男性|女性)?$/);
    if (shopMatch) {
      const shopName = shopMatch[1].trim();
      const type = shopMatch[2];
      shopData[shopName] = shopData[shopName] || { guest: 0, free: 0 };
      if (type === 'ゲスト') shopData[shopName].guest += count;
    }
  });

  summaryData = { total, foreignTotal, maleTotal, femaleTotal, door, foreignDoor, doorLate, foreignDoorLate };
}

function updateDisplay() {
  let categoryText = '';
  let totalPrice = 0;

  categoryKeys.forEach(key => {
    const price = parseInt(document.getElementById('price_' + key).value) || 0;
    const people = categoryCount[key];
    totalPrice += people * price;
    categoryText += `${categoryLabels[key]} : ${people}人 単価 ${price}円\n`;
  });

  document.getElementById('categorySummary').innerText = categoryText;
  document.getElementById('totalPrice').innerText = `合計金額: ${totalPrice.toLocaleString()} 円`;

  let html = '';
  html += 'キャッシャー集計\n\n';
  html += `${getYesterdayDate()}\n\n`;
  html += `総数:${Math.round(summaryData.total)}(外国人${Math.round(summaryData.foreignTotal)}人)\n`;
  html += `M:${Math.round(summaryData.maleTotal)} W:${Math.round(summaryData.femaleTotal)}\n\n`;

  document.getElementById('output').innerText = html;
}

function copyText() {
  navigator.clipboard.writeText(document.getElementById('output').innerText).then(() => {
    alert('コピー完了！');
  }, () => {
    alert('コピー失敗...');
  });
}

document.querySelectorAll('input[type="number"]').forEach(input => {
  input.addEventListener('input', updateDisplay);
});
</script>

</body>
</html>