<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>CSV集計ツール ver0.0.4</title>
  <style>
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px;
      background-color: #f0f0f0;
      border-bottom: 1px solid #ccc;
    }
    #header h1 {
      margin: 0;
      font-size: 24px;
    }
    #header span {
      font-size: 14px;
      color: #666;
    }
    #columns {
      margin-top: 20px;
    }
    #output {
      margin-top: 30px;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>CSV集計ツール ver0.0.4</h1>
  <span>更新日: 2025/04/27</span>
</div>

<input type="file" id="csvFileInput" accept=".csv" />

<div id="columns"></div>
<div id="output"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
document.getElementById('csvFileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function(e) {
        // Shift_JISでデコード
        const text = new TextDecoder('shift-jis').decode(e.target.result);
        
        Papa.parse(text, {
            header: true,
            skipEmptyLines: true,
            complete: function(results) {
                const data = results.data;
                showColumns(data);
                processSimpleSum(data);
            }
        });
    };
    reader.readAsArrayBuffer(file);
});

function showColumns(data) {
    const keys = Object.keys(data[0] || {});
    document.getElementById('columns').innerHTML = '<h2>検出された列名一覧:</h2><ul>' + keys.map(key => `<li>${key}</li>`).join('') + '</ul>';
}

function processSimpleSum(data) {
    if (!data || data.length === 0) {
        document.getElementById('output').innerHTML = '<p>データが空です</p>';
        return;
    }

    let countColumnName = null;
    const keys = Object.keys(data[0]);
    for (const key of keys) {
        if (key.replace(/\s/g, '').includes('販売商品数')) {
            countColumnName = key;
            break;
        }
    }
    if (!countColumnName) {
        document.getElementById('output').innerHTML += '<p style="color:red;">販売商品数の列が見つかりません</p>';
        return;
    }

    let salesSum = 0;
    let returnSum = 0;

    data.forEach(row => {
        const rawCount = row[countColumnName];
        const count = parseFloat(rawCount) || 0;

        if (count > 0) {
            salesSum += count;
        } else if (count < 0) {
            returnSum += count;
        }
    });

    const total = salesSum + returnSum;

    let html = '';
    html += `<h2>総入場数: ${Math.round(total)} 人</h2>`;
    html += `<p>（販売商品数合計: ${Math.round(salesSum)}，返品商品数合計: ${Math.round(returnSum)}）</p>`;

    document.getElementById('output').innerHTML = html;
}
</script>

</body>
</html>