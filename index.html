<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>キャッシャー集計 ver0.5.7</title>
<style>
 body{font-family:monospace;margin:20px}
 #header{display:flex;justify-content:space-between;align-items:center;
         border-bottom:1px solid #ccc;padding-bottom:8px}
 table{border-collapse:collapse;margin-top:18px}
 th,td{padding:4px 8px;border:1px solid #aaa}
 th{background:#eee}
 input[type=number]{width:70px;text-align:right}
 #totalPrice{margin:18px 0;font-size:22px;font-weight:bold;color:#c00}
 #output{white-space:pre;margin-top:20px}
 #copyBtn{padding:8px 18px;font-size:16px}
</style>
</head>
<body>

<div id="header">
  <h1>キャッシャー集計 ver0.5.7</h1>
  <span>更新日 2025/04/27</span>
</div>

<input type="file" id="csvFile" accept=".csv">

<table id="priceTable">
  <thead><tr><th>カテゴリ / 商品名</th><th>人数</th><th>単価(円)</th></tr></thead>
  <tbody id="priceBody"></tbody>
</table>

<div id="totalPrice"></div>
<div id="output"></div>
<button id="copyBtn" onclick="copyText()">コピー</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/* ------ 固定カテゴリ ------ */
const fixedCats={
  '22m':'22-1 男性','22w':'22-1 女性',
  'localm':'ローカル男性','localw':'ローカル女性',
  'localgm':'ローカルG男性','localgw':'ローカルG女性',
  'gm':'G男性','gw':'G女性',
  'guestm':'ゲスト男性','guestw':'ゲスト女性',
  '22guestm':'22:00-1:00ゲスト男性','22guestw':'22:00-1:00ゲスト女性'
};
let count={},otherItems={},reEntry=0;

/* CSV 選択 */
document.getElementById('csvFile').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  const rd=new FileReader();
  rd.onload=v=>{
    const txt=new TextDecoder('shift-jis').decode(v.target.result);
    Papa.parse(txt,{header:true,skipEmptyLines:true,
      complete:r=>{
        reset();
        parseRows(r.data);
        buildTable();
        recalc();
      }});
  };
  rd.readAsArrayBuffer(f);
});

/* 初期化 */
function reset(){
  count={}; Object.keys(fixedCats).forEach(k=>count[k]=0);
  reEntry=0; otherItems={};
}

/* 行解析 */
function parseRows(rows){
  const colCnt=rows[0]&&Object.keys(rows[0]).find(k=>k.replace(/\s/g,'').includes('販売商品数'));
  rows.forEach(row=>{
    const cat=(row['カテゴリー']||'').trim();
    let name=(row['商品名']||'').trim().replace(/22~1/g,'22-1');
    const qty=parseFloat(row[colCnt])||0;
    if(!qty) return;

    if(cat==='その他'){
      if(name.includes('再入場')){reEntry+=qty;}
      else{
        if(!otherItems[name]) otherItems[name]={cnt:0,price:0};
        otherItems[name].cnt+=qty;
      }
      return;
    }
    /* 固定カテゴリ */
    if(cat.includes('22-1')&&cat.includes('男性')&&!cat.includes('ゲスト'))       count['22m']+=qty;
    else if(cat.includes('22-1')&&cat.includes('女性')&&!cat.includes('ゲスト'))  count['22w']+=qty;
    else if(cat.includes('22-1')&&cat.includes('ゲスト')&&cat.includes('男性'))   count['22guestm']+=qty;
    else if(cat.includes('22-1')&&cat.includes('ゲスト')&&cat.includes('女性'))   count['22guestw']+=qty;
    else if(cat.includes('ローカルG男性')) count['localgm']+=qty;
    else if(cat.includes('ローカルG女性')) count['localgw']+=qty;
    else if(cat.includes('ローカル男性'))  count['localm'] +=qty;
    else if(cat.includes('ローカル女性'))  count['localw'] +=qty;
    else if(cat==='G男性') count['gm']+=qty;
    else if(cat==='G女性') count['gw']+=qty;
    else if(cat==='ゲスト男性') count['guestm']+=qty;
    else if(cat==='ゲスト女性') count['guestw']+=qty;
  });
}

/* テーブル生成 */
function buildTable(){
  const body=document.getElementById('priceBody');
  body.innerHTML='';
  /* 固定 */
  Object.keys(fixedCats).forEach(k=>{
    body.appendChild(makeRow(fixedCats[k],count[k],'price_'+k));
  });
  /* その他 */
  Object.keys(otherItems).forEach(n=>{
    const id='price_other_'+n.replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
    body.appendChild(makeRow(n,otherItems[n].cnt,id));
  });
  /* 再入場(固定500円) */
  body.appendChild(makeRow('再入場',reEntry,null,500,true));
  /* 価格入力ハンドラ */
  body.querySelectorAll('input[type=number]').forEach(inp=>inp.oninput=recalc);
}

/* 行要素 */
function makeRow(label,cnt,id,init=0,disabled=false){
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${label}</td><td>${cnt}</td>
                <td>${disabled?init:`<input type="number" id="${id}" value="${init}">`}</td>`;
  return tr;
}

/* 再計算 */
function recalc(){
  let sum=0;
  /* 固定 */
  Object.keys(fixedCats).forEach(k=>{
    const price=+document.getElementById('price_'+k).value||0;
    sum+=count[k]*price;
  });
  /* その他 */
  Object.keys(otherItems).forEach(n=>{
    const id='price_other_'+n.replace(/\s+/g,'_').replace(/[^\w\-]/g,'');
    const price=+document.getElementById(id).value||0;
    sum+=otherItems[n].cnt*price;
  });
  /* 再入場 */
  sum+=reEntry*500;
  document.getElementById('totalPrice').textContent=`合計金額: ${sum.toLocaleString()} 円`;

  /* コピー本文（例として人数合計だけ簡潔に） */
  const totalPeople=Object.values(count).reduce((a,b)=>a+b,0)+
                    Object.values(otherItems).reduce((a,b)=>a+b.cnt,0);
  document.getElementById('output').textContent=
      `キャッシャー集計\n\n${getYesterdayDate()}\n\n総人数:${totalPeople}`;
}

/* コピー */
function copyText(){
  navigator.clipboard.writeText(document.getElementById('output').textContent)
    .then(()=>alert('コピー完了！'))
    .catch(()=>alert('コピー失敗…'));
}
</script>
</body>
</html>