<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>料金計算ツール ver0.2.1</title>
<style>
  body{font-family:monospace;margin:20px}
  #head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ccc;padding-bottom:8px}
  table{border-collapse:collapse;margin-top:16px}
  th,td{border:1px solid #aaa;padding:4px 8px}
  th{background:#eee}
  input[type=number]{width:90px;text-align:right}
  #total{margin:18px 0;font-size:22px;font-weight:bold;color:#c00}
</style>
</head>
<body>

<div id="head"><h1>料金計算ツール ver0.2.1.1</h1><span id="upd"></span></div>

<input type="file" id="csv" accept=".csv">

<table id="tbl">
  <thead><tr><th>カテゴリー / 商品名</th><th>人数</th><th>単価 (円)</th></tr></thead>
  <tbody></tbody>
</table>

<div id="total"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/* 22-1 ブロック内の並び順 */
const order22 = [
  '22-1 男性','22-1 女性','22-1 G男性','22-1 G女性',
  '22-1 男性ゲスト','22-1 女性ゲスト',
  '22-1 G男性ゲスト','22-1 G女性ゲスト'
];

/* 通常ブロックの並び順（22-1 以外）*/
const orderNorm = [
  'ローカル男性','ローカル女性',
  'ローカルG男性','ローカルG女性',
  '外国人男性','外国人女性',
  '男性ゲスト','女性ゲスト',
  'ローカルGゲスト男性','ローカルGゲスト女性',
  'ローカルゲスト男性','ローカルゲスト女性',
  'G男性ゲスト','G女性ゲスト'
];

/* 並び順キーを返す関数 */
function sortKey(label){
  if(label.startsWith('22-1')){
    const idx = order22.findIndex(t=>label.startsWith(t));
    return '0' + (idx>=0?String(idx).padStart(2,'0'):'98') + label;
  }
  if(label.includes('フリー')) return '3'+label;            // 最下段
  const idx2 = orderNorm.findIndex(t=>label.startsWith(t));
  return '1' + (idx2>=0?String(idx2).padStart(2,'0'):'99') + label;
}

/* util */
const tbody = document.querySelector('#tbl tbody');
document.getElementById('upd').textContent = '更新 ' + new Date().toLocaleDateString();
const id = s => 'p_'+btoa(unescape(encodeURIComponent(s))).replace(/=+$/,'');

/* CSV 読み込み */
document.getElementById('csv').addEventListener('change',e=>{
  const f=e.target.files[0]; if(!f) return;
  new Response(f).arrayBuffer().then(buf=>{
    const txt = new TextDecoder('shift-jis').decode(buf);
    Papa.parse(txt,{header:true,skipEmptyLines:true,complete:r=>{
      const list = summarize(r.data);
      buildTable(list);
      calc();
    }});
  });
});

/* ① CSV を配列へ集計 */
function summarize(rows){
  const cntCol = rows[0] && Object.keys(rows[0]).find(k=>k.replace(/\s/g,'').includes('販売商品数'));
  const mapCat = new Map();   // 固定カテゴリー
  const mapEtc = new Map();   // カテゴリー＝その他 → 商品名

  rows.forEach(row=>{
    /* ← カテゴリーにも 22~1 → 22-1 補正 */
    const cat  = (row['カテゴリー']||'').trim().replace(/22~1/g,'22-1');
    const name = (row['商品名']||'').trim().replace(/22~1/g,'22-1');
    const n    = +row[cntCol]||0;  if(!n) return;

    if(cat === 'その他'){
      mapEtc.set(name,(mapEtc.get(name)||0)+n);
    }else{
      mapCat.set(cat,(mapCat.get(cat)||0)+n);
    }
  });

  /* map → list */
  const list = [
    ...[...mapCat.entries()].map(([label,cnt])=>({label,cnt,priceId:id(label)})),
    ...[...mapEtc.entries()].map(([label,cnt])=>({label,cnt,priceId:id(label)}))
  ];

  /* フリー行が無ければ補完 */
  if(!list.find(o=>o.label.includes('フリー')))
       list.push({label:'フリー',cnt:0,priceId:null});

  /* 並び替え */
  return list.sort((a,b)=>sortKey(a.label).localeCompare(sortKey(b.label),'ja')||
                          a.label.localeCompare(b.label,'ja'));
}

/* ② テーブルを描画 */
function buildTable(arr){
  tbody.innerHTML='';
  arr.forEach(o=>{
    const lock = o.label.includes('フリー');      // フリー行は入力禁止
    const tr   = document.createElement('tr');
    tr.innerHTML =
      `<td>${o.label}</td><td>${o.cnt}</td>`+
      `<td>${lock?0:`<input type="number" id="${o.priceId}" value="0">`}</td>`;
    tbody.appendChild(tr);
    if(!lock) document.getElementById(o.priceId).oninput = calc;
  });
}

/* ③ 合計金額を計算 */
function calc(){
  let sum=0;
  tbody.querySelectorAll('tr').forEach(tr=>{
    const label = tr.cells[0].textContent.trim();
    const num   = +tr.cells[1].textContent;
    let price   = 0;
    const inp   = tr.querySelector('input');
    if(inp)      price = +inp.value||0;
    else if(label.includes('フリー')) price = 0;
    sum += num * price;
  });
  document.getElementById('total').textContent =
        `合計金額: ${sum.toLocaleString()} 円`;
}
</script>
</body>
</html>