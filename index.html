<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>料金計算ツール ver0.1</title>
<style>
 body{font-family:monospace;margin:20px}
 #head{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ccc;padding-bottom:8px}
 table{border-collapse:collapse;margin-top:16px}
 th,td{border:1px solid #aaa;padding:4px 8px}
 th{background:#eee}
 input[type=number]{width:90px;text-align:right}
 #total{margin:18px 0;font-size:22px;font-weight:bold;color:#c00}
</style>
</head>
<body>

<div id="head"><h1>料金計算ツール ver0.1</h1><span id="upd"></span></div>

<input type="file" id="csv" accept=".csv">

<table id="tbl"><thead>
  <tr><th>カテゴリー / 商品名</th><th>人数</th><th>単価 (円)</th></tr>
</thead><tbody></tbody></table>

<div id="total"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
const tbody=document.querySelector('#tbl tbody');
document.getElementById('upd').textContent='更新 '+new Date().toLocaleDateString();

/* 並び順判定 */
function key(label){
 if(label.includes('22-1')) return '0'+label;
 if(label.includes('フリー')) return '2'+label;
 if(label==='その他') return '1Z';             // 実際は展開済みで来ない
 return '1'+label;                             // 通常
}

/* CSV 読み込み */
document.getElementById('csv').addEventListener('change',e=>{
 const f=e.target.files[0]; if(!f) return;
 new Response(f).arrayBuffer().then(buf=>{
  const txt=new TextDecoder('shift-jis').decode(buf);
  Papa.parse(txt,{header:true,skipEmptyLines:true,complete:r=>{
     makeTable(summarize(r.data));
     calc();
  }});
 });
});

/* 集計：{label, cnt, priceId}[] 生成 */
function summarize(rows){
 const cntCol=rows[0]&&Object.keys(rows[0]).find(k=>k.replace(/\s/g,'').includes('販売商品数'));
 const map=new Map(), etc=new Map();

 rows.forEach(row=>{
   const cat=(row['カテゴリー']||'').trim();
   const name=(row['商品名']||'').trim().replace(/22~1/g,'22-1');
   const n=+row[cntCol]||0; if(!n) return;

   if(cat==='その他'){                       // その他 → 商品名ごと
     etc.set(name,(etc.get(name)||0)+n);
   }else{
     map.set(cat,(map.get(cat)||0)+n);
   }
 });

 /* map → 配列へ */
 const list=[...map.entries()].map(([label,cnt])=>({label,cnt,priceId:id(label)}));
 /* etc（その他）を append */
 [...etc.entries()].forEach(([label,cnt])=>list.push({label,cnt,priceId:id(label)}));
 /* フリー補完 */
 if(!list.find(o=>o.label.includes('フリー')))
     list.push({label:'フリー',cnt:0,priceId:null});

 /* ソート */
 return list.sort((a,b)=>key(a.label).localeCompare(key(b.label),'ja'));
}
function id(label){return 'p_'+btoa(unescape(encodeURIComponent(label))).replace(/=+$/,'');}

/* 表生成 */
function makeTable(arr){
 tbody.innerHTML='';
 arr.forEach(o=>{
   const lock=o.label.includes('フリー');
   const tr=document.createElement('tr');
   tr.innerHTML=
     `<td>${o.label}</td><td>${o.cnt}</td>`+
     `<td>${lock?0:`<input type="number" id="${o.priceId}" value="0">`}</td>`;
   tbody.appendChild(tr);
   if(!lock) document.getElementById(o.priceId).oninput=calc;
 });
}

/* 合計金額計算 */
function calc(){
 let sum=0;
 tbody.querySelectorAll('tr').forEach(tr=>{
   const label=tr.cells[0].textContent.trim();
   const n    =+tr.cells[1].textContent;
   let price  =0;
   const inp  =tr.querySelector('input');
   if(inp) price=+inp.value||0;
   else if(label.includes('フリー')) price=0;
   sum+=n*price;
 });
 document.getElementById('total').textContent=`合計金額: ${sum.toLocaleString()} 円`;
}
</script>
</body>
</html>