<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>キャッシャー集計 ver0.5.3</title>
  <style>
    body {
      font-family: monospace;
      margin: 20px;
    }
    #header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding-bottom: 10px;
      border-bottom: 1px solid #ccc;
    }
    #inputs {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .input-group {
      margin-bottom: 10px;
    }
    label {
      width: 200px;
      display: inline-block;
    }
    input[type="number"] {
      width: 80px;
      text-align: center;
    }
    #output {
      margin-top: 20px;
      white-space: pre;
      font-family: monospace;
    }
    #copyButton, #generateButton {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      margin-right: 10px;
    }
    #totalPrice {
      font-size: 22px;
      font-weight: bold;
      color: red;
      margin-top: 20px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>

<div id="header">
  <h1>キャッシャー集計 ver0.5.3</h1>
  <span>更新日: 2025/04/27</span>
</div>

<input type="file" id="csvFileInput" accept=".csv" />

<div id="inputs">
  <h2>カテゴリごとの料金設定</h2>
  <div class="input-group"><label>22-1 男性 料金:</label><input type="number" id="price_22m" value="0"></div>
  <div class="input-group"><label>22-1 女性 料金:</label><input type="number" id="price_22w" value="0"></div>
  <div class="input-group"><label>ローカル男性 料金:</label><input type="number" id="price_localm" value="0"></div>
  <div class="input-group"><label>ローカル女性 料金:</label><input type="number" id="price_localw" value="0"></div>
  <div class="input-group"><label>ローカルG男性 料金:</label><input type="number" id="price_localgm" value="0"></div>
  <div class="input-group"><label>ローカルG女性 料金:</label><input type="number" id="price_localgw" value="0"></div>
  <div class="input-group"><label>G男性 料金:</label><input type="number" id="price_gm" value="0"></div>
  <div class="input-group"><label>G女性 料金:</label><input type="number" id="price_gw" value="0"></div>
  <div class="input-group"><label>ゲスト男性 料金:</label><input type="number" id="price_guestm" value="0"></div>
  <div class="input-group"><label>ゲスト女性 料金:</label><input type="number" id="price_guestw" value="0"></div>
  <div class="input-group"><label>22:00-1:00ゲスト男性 料金:</label><input type="number" id="price_22guestm" value="0"></div>
  <div class="input-group"><label>22:00-1:00ゲスト女性 料金:</label><input type="number" id="price_22guestw" value="0"></div>
</div>

<button id="generateButton" onclick="generateOutput()">出力</button>
<button id="copyButton" onclick="copyText()">コピー</button>

<div id="totalPrice"></div>
<div id="output"></div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
let shopData = {};
let summaryData = {};
let categoryCount = {
  '22m': 0,
  '22w': 0,
  'localm': 0,
  'localw': 0,
  'localgm': 0,
  'localgw': 0,
  'gm': 0,
  'gw': 0,
  'guestm': 0,
  'guestw': 0,
  '22guestm': 0,
  '22guestw': 0
};

document.getElementById('csvFileInput').addEventListener('change', function(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    const text = new TextDecoder('shift-jis').decode(e.target.result);
    Papa.parse(text, {
      header: true,
      skipEmptyLines: true,
      complete: function(results) {
        const data = results.data;
        processCSVData(data);
      }
    });
  };
  reader.readAsArrayBuffer(file);
});

function getYesterdayDate() {
  const today = new Date();
  today.setDate(today.getDate() - 1);
  return `${today.getFullYear()}/${today.getMonth() + 1}/${today.getDate()}`;
}

function padRight(str, length) {
  return (str + ' '.repeat(length)).slice(0, length);
}

function padLeft(str, length) {
  str = String(str);
  return ' '.repeat(length - str.length) + str;
}

function processCSVData(data) {
  Object.keys(categoryCount).forEach(key => categoryCount[key] = 0);

  let door = 0, foreignDoor = 0, doorLate = 0, foreignDoorLate = 0;
  let total = 0, maleTotal = 0, femaleTotal = 0, foreignTotal = 0;
  shopData = {};

  let countColumn = Object.keys(data[0]).find(key => key.replace(/\s/g, '').includes('販売商品数'));
  if (!countColumn) {
    document.getElementById('output').innerText = '販売商品数の列が見つかりません';
    return;
  }

  data.forEach(row => {
    const item = row['商品名']?.trim();
    if (!item || item.includes('再入場')) return;

    const count = parseFloat(row[countColumn]) || 0;
    const itemFixed = item.replace(/22~1/g, '22-1');
    const normalizedItem = itemFixed.replace(/^22-1\s*/, '');

    total += count;

    if (itemFixed.includes('G男性') || itemFixed.includes('G女性')) foreignTotal += count;
    if (itemFixed.includes('男性')) maleTotal += count;
    if (itemFixed.includes('女性')) femaleTotal += count;

    if (itemFixed.includes('G男性') || itemFixed.includes('G女性')) {
      if (itemFixed.includes('22-1')) foreignDoorLate += count;
      else foreignDoor += count;
    } else if (itemFixed.includes('男性') || itemFixed.includes('ローカルG男性') || itemFixed.includes('女性') || itemFixed.includes('ローカルG女性')) {
      if (itemFixed.includes('22-1')) doorLate += count;
      else door += count;
    }

    if (itemFixed.includes('22-1ゲスト男性')) categoryCount['22guestm'] += count;
    else if (itemFixed.includes('22-1ゲスト女性')) categoryCount['22guestw'] += count;
    else if (itemFixed.includes('22-1男性')) categoryCount['22m'] += count;
    else if (itemFixed.includes('22-1女性')) categoryCount['22w'] += count;
    else if (itemFixed.includes('ローカルG男性')) categoryCount['localgm'] += count;
    else if (itemFixed.includes('ローカルG女性')) categoryCount['localgw'] += count;
    else if (itemFixed.includes('ローカル男性')) categoryCount['localm'] += count;
    else if (itemFixed.includes('ローカル女性')) categoryCount['localw'] += count;
    else if (itemFixed.includes('G男性')) categoryCount['gm'] += count;
    else if (itemFixed.includes('G女性')) categoryCount['gw'] += count;
    else if (itemFixed.includes('ゲスト男性')) categoryCount['guestm'] += count;
    else if (itemFixed.includes('ゲスト女性')) categoryCount['guestw'] += count;

    const shopMatch = normalizedItem.match(/^(.+?)(ゲスト|フリー)(男性|女性)?$/);
    if (shopMatch) {
      const shopName = shopMatch[1].trim();
      const type = shopMatch[2];
      shopData[shopName] = shopData[shopName] || { guest: 0, free: 0 };
      if (type === 'ゲスト') shopData[shopName].guest += count;
    }
  });

  summaryData = { total, foreignTotal, maleTotal, femaleTotal, door, foreignDoor, doorLate, foreignDoorLate };
}

function generateOutput() {
  const prices = {
    '22m': parseInt(document.getElementById('price_22m').value) || 0,
    '22w': parseInt(document.getElementById('price_22w').value) || 0,
    'localm': parseInt(document.getElementById('price_localm').value) || 0,
    'localw': parseInt(document.getElementById('price_localw').value) || 0,
    'localgm': parseInt(document.getElementById('price_localgm').value) || 0,
    'localgw': parseInt(document.getElementById('price_localgw').value) || 0,
    'gm': parseInt(document.getElementById('price_gm').value) || 0,
    'gw': parseInt(document.getElementById('price_gw').value) || 0,
    'guestm': parseInt(document.getElementById('price_guestm').value) || 0,
    'guestw': parseInt(document.getElementById('price_guestw').value) || 0,
    '22guestm': parseInt(document.getElementById('price_22guestm').value) || 0,
    '22guestw': parseInt(document.getElementById('price_22guestw').value) || 0,
  };

  let totalPrice = Object.keys(categoryCount).reduce((sum, key) => {
    return sum + (categoryCount[key] * prices[key]);
  }, 0);

  document.getElementById('totalPrice').innerText = `合計金額: ${totalPrice.toLocaleString()} 円`;

  let html = '';
  html += 'キャッシャー集計\n\n';
  html += `${getYesterdayDate()}\n\n`;
  html += `総数:${Math.round(summaryData.total)}(外国人${Math.round(summaryData.foreignTotal)}人)\n`;
  html += `M:${Math.round(summaryData.maleTotal)} W:${Math.round(summaryData.femaleTotal)}\n\n`;
  html += `${padRight('Door', 20)}: ${padLeft(Math.round(summaryData.door), 4)}\n`;
  html += `${padRight('外国人Door', 20)}: ${padLeft(Math.round(summaryData.foreignDoor), 4)}\n`;
  html += `${padRight('22:00-1:00 Door', 20)}: ${padLeft(Math.round(summaryData.doorLate), 4)}\n`;
  html += `${padRight('22:00-1:00 外国人Door', 20)}: ${padLeft(Math.round(summaryData.foreignDoorLate), 4)}\n\n`;

  for (const [shop, { guest }] of Object.entries(shopData)) {
    html += `${shop}\n　${padLeft(guest, 3)}（ゲスト${padLeft(guest, 3)} フリー[0]）\n\n`;
  }

  document.getElementById('output').innerText = html;
}

function copyText() {
  navigator.clipboard.writeText(document.getElementById('output').innerText).then(() => {
    alert('コピー完了！');
  }, () => {
    alert('コピー失敗...');
  });
}
</script>

</body>
</html>