<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>キャッシャー集計 ver0.6.4</title>
<style>
 body{font-family:monospace;margin:20px}
 #header{display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid #ccc;padding-bottom:8px}
 table{border-collapse:collapse;margin-top:18px}
 th,td{border:1px solid #aaa;padding:4px 8px}
 th{background:#eee}
 input[type=number]{width:80px;text-align:right}
 #total{font-size:22px;font-weight:bold;color:#c00;margin:18px 0}
 #big{white-space:pre;margin-top:20px}
 #copy{padding:8px 20px;font-size:16px}
</style>
</head>
<body>

<div id="header"><h1>キャッシャー集計 ver0.6.4</h1><span id="upd"></span></div>

<input type="file" id="csv" accept=".csv">

<table id="tbl"><thead>
<tr><th>カテゴリー / 商品名</th><th>人数</th><th>単価(円)</th></tr>
</thead><tbody></tbody></table>

<div id="total"></div>

<h3>コピー用テキスト</h3>
<div id="big"></div>
<button id="copy" onclick="cp()">コピー</button>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.2/papaparse.min.js"></script>
<script>
/* 並び順ルール */
function orderKey(l){
 if(l.startsWith('22-1')&&!l.includes('ゲスト')) return '00'
 if(l.startsWith('22-1')&& l.includes('ゲスト')) return '01'
 if(l.startsWith('ローカル')&&!l.includes('ゲスト')) return '02'
 if(l.startsWith('G')&&!l.includes('ゲスト'))       return '03'
 if(l.startsWith('ローカル')&&l.includes('ゲスト'))  return '04'
 if(l.startsWith('Gゲスト'))                        return '05'
 if(l==='フリー')                                   return '06'
 return '90'+l                                      /* その他は後ろで五十音 */
}

const tbody=document.querySelector('#tbl tbody')
let rows=[],reIn=0,shop={},door=0,fDoor=0,total=0,foreign=0,male=0,female=0
document.getElementById('upd').textContent='更新 '+new Date().toLocaleDateString()

/* CSV */
document.getElementById('csv').addEventListener('change',e=>{
 const f=e.target.files[0];if(!f) return
 new Response(f).arrayBuffer().then(buf=>{
  const txt=new TextDecoder('shift-jis').decode(buf)
  Papa.parse(txt,{header:true,skipEmptyLines:true,complete:r=>{
    parse(r.data)
    build()
    calc()
 }})})
})

function parse(d){
 rows=[];reIn=0;shop={};door=0;fDoor=0;total=0;foreign=0;male=0;female=0
 const cntCol=d[0]&&Object.keys(d[0]).find(k=>k.replace(/\s/g,'').includes('販売商品数'))
 d.forEach(r=>{
  const cat=(r['カテゴリー']||'').trim()
  let name=(r['商品名']||'').trim().replace(/22~1/g,'22-1')
  const n=+r[cntCol]||0;if(!n) return

  if(cat==='その他'){
    if(name.includes('再入場')){reIn+=n;return}
    addRow(name,n)
  }else{
    addRow(cat,n)
  }

  /* 集計用 */
  if(cat.includes('外国人')){foreign+=n}
  if(cat.includes('男性'))  {male+=n}else if(cat.includes('女性')){female+=n}
  if(cat.includes('Door')&&cat.includes('外国人')){fDoor+=n}
  else if(cat.includes('Door')){door+=n}

  const shopMatch=name.match(/^(.+?)(ゲスト|フリー)/)
  if(shopMatch){
    const s=shopMatch[1].trim()
    shop[s]=shop[s]||{guest:0,free:0}
    if(shopMatch[2]==='ゲスト') shop[s].guest+=n
    else shop[s].free+=n
  }

  total+=n
 })
}
function addRow(label,n){
 let row=rows.find(r=>r.label===label)
 if(!row){row={label,cnt:0,price:0};rows.push(row)}
 row.cnt+=n
}
function build(){
 tbody.innerHTML=''
 rows.sort((a,b)=>orderKey(a.label).localeCompare(orderKey(b.label))||
                  a.label.localeCompare(b.label,'ja'))
 /* フリー補完 */
 if(!rows.find(r=>r.label==='フリー')) rows.push({label:'フリー',cnt:0,price:0})
 rows.forEach(r=>{
  const id='p_'+btoa(unescape(encodeURIComponent(r.label))).replace(/=+$/,'')
  const lock=(r.label==='フリー')
  const tr=document.createElement('tr')
  tr.innerHTML=`<td>${r.label}</td><td>${r.cnt}</td><td>${lock?0:`<input type=number id=${id} value=${r.price}>`}</td>`
  tbody.appendChild(tr)
  if(!lock) document.getElementById(id).oninput=calc
 })
 const tr=document.createElement('tr')
 tr.innerHTML=`<td>再入場</td><td>${reIn}</td><td>500</td>`
 tbody.appendChild(tr)
}
function calc(){
 let sum=0
 tbody.querySelectorAll('tr').forEach(tr=>{
  const label=tr.cells[0].textContent.trim()
  const num=+tr.cells[1].textContent
  let price=0
  const inp=tr.querySelector('input'); if(inp) price=+inp.value||0
  else if(label==='再入場') price=500
  else if(label==='フリー') price=0
  sum+=num*price
 })
 document.getElementById('total').textContent=`合計金額: ${sum.toLocaleString()} 円`
 buildBig(sum)
}
function buildBig(sum){
 let txt='キャッシャー〆\n\n'
 txt+=`総数:${total}(外国人${foreign}名)\n`
 txt+=`M:${male} W:${female}\n\n`
 txt+=`外国人Door ${fDoor}\nDoor ${door}\n\n`
 txt+='店ゲスト ,店Free は下\n\n'
 Object.keys(shop).forEach(s=>{
  const g=shop[s].guest||0,f=shop[s].free||0
  txt+=`${s}\n　${g+f}(ゲスト${g}フリー${f})\n`
 })
 txt+='\n22-23        IN 0 OUT 0\n23-24        IN 0 OUT 0\n0-1           IN 0 OUT 0\n1-2           IN 0 OUT 0\n2-3           IN 0 OUT 0\n3-4           IN 0 OUT 0\n4-4:30     IN 0 OUT 0\n'
 txt+=`\n合計金額:${sum.toLocaleString()}円`
 document.getElementById('big').textContent=txt
}
function cp(){navigator.clipboard.writeText(document.getElementById('big').textContent).then(()=>alert('コピー完了'))}
</script>
</body>
</html>